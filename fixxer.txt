node_modules/whatsapp-web.js/src/util/Injected/Utils.js


window.WWebJS.getChat = async (chatId, { getAsModel = true } = {}) => {
    const isChannel = /@\w*newsletter\b/.test(chatId);
    const chatWid = window.Store.WidFactory.createWid(chatId);

    let chat;

    if (isChannel) {
      try {
        chat = window.Store.NewsletterCollection.get(chatId);
        if (!chat) {
          await window.Store.ChannelUtils.loadNewsletterPreviewChat(chatId);
          chat = await window.Store.NewsletterCollection.find(chatWid);
        }
      } catch (err) {
        chat = null;
      }
    } else {
      chat = await window.Store.FindOrCreateChat.findOrCreateLatestChat(chatWid)
      .then(chat => chat.chat)
      .catch(async err => {
        let query = window.require("WAWebContactSyncUtils").constructUsyncDeltaQuery([{
          type: "add",
          phoneNumber: chatWid.user
        }]);
        let result =  await query.execute();
        if (result && Array.isArray(result.list) &&result.list.length > 0 &&result.list[0] &&result.list[0].lid) {
          chatLid = window.Store.WidFactory.createWid(result.list[0].lid)
          return  await window.Store.FindOrCreateChat.findOrCreateLatestChat(chatLid)  .then(chat => chat.chat)  .catch(async err => {})

        }
      })
    }

    return getAsModel && chat
    ? await window.WWebJS.getChatModel(chat, { isChannel: isChannel })
    : chat;
  };